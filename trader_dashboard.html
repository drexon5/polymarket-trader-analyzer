<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Trader Dashboard - Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: #0f1419; color: #e7e9ea; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); }
        h1 { font-size: 32px; margin-bottom: 10px; }
        .subtitle { opacity: 0.9; font-size: 16px; }
        .upload-section { background: #1a1f2e; padding: 30px; border-radius: 12px; margin-bottom: 30px; border: 2px dashed #667eea; }
        .upload-btn { background: #667eea; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .upload-btn:hover { background: #5568d3; transform: translateY(-2px); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1a1f2e; padding: 20px; border-radius: 12px; border-left: 4px solid #667eea; }
        .stat-card.warning { border-left-color: #f91880; }
        .stat-card.success { border-left-color: #00ba7c; }
        .stat-label { font-size: 14px; opacity: 0.7; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: bold; color: #667eea; }
        .stat-card.warning .stat-value { color: #f91880; }
        .stat-card.success .stat-value { color: #00ba7c; }
        .filters-section { background: #1a1f2e; padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #38444d; padding-bottom: 10px; }
        .filter-tab { padding: 10px 20px; background: transparent; border: none; color: #e7e9ea; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-size: 14px; }
        .filter-tab.active { border-bottom-color: #667eea; color: #667eea; }
        .filter-panel { display: none; }
        .filter-panel.active { display: block; }
        .filter-group { margin-bottom: 20px; }
        .filter-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #667eea; }
        .filter-group input, .filter-group select { width: 100%; padding: 10px; background: #0f1419; border: 1px solid #38444d; border-radius: 6px; color: #e7e9ea; font-size: 14px; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; padding: 12px; background: #0f1419; border-radius: 6px; margin-bottom: 15px; }
        .checkbox-group input[type="checkbox"] { width: auto; cursor: pointer; }
        .checkbox-group label { margin: 0; cursor: pointer; color: #e7e9ea; }
        .info-box { background: #1a2332; border-left: 4px solid #667eea; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .info-box h4 { color: #667eea; margin-bottom: 8px; }
        .info-box p { font-size: 13px; opacity: 0.9; line-height: 1.5; }
        .charts-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .chart-card { background: #1a1f2e; padding: 20px; border-radius: 12px; }
        .chart-card h3 { margin-bottom: 15px; color: #667eea; }
        .results-section { background: #1a1f2e; padding: 25px; border-radius: 12px; }
        .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .sort-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .sort-controls select { padding: 8px 12px; background: #0f1419; border: 1px solid #667eea; border-radius: 6px; color: #e7e9ea; }
        .trader-table { width: 100%; border-collapse: collapse; }
        .trader-table th { background: #667eea; padding: 12px; text-align: left; font-weight: 600; position: sticky; top: 0; font-size: 13px; }
        .trader-table td { padding: 12px; border-bottom: 1px solid #38444d; font-size: 13px; }
        .trader-table tr:hover { background: #252d3d; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; background: #667eea; color: white; }
        .red-flag { background: #f91880; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; display: inline-block; }
        .green-badge { background: #00ba7c; padding: 3px 8px; border-radius: 4px; font-size: 11px; display: inline-block; }
        .profile-link { color: #667eea; text-decoration: none; }
        .profile-link:hover { text-decoration: underline; }
        .positive { color: #00ba7c; }
        .negative { color: #f91880; }
        .hidden { display: none; }
        .export-btn { background: #00ba7c; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .export-btn:hover { background: #00a36c; }
        .toggle-section { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
        .toggle-btn { padding: 8px 16px; background: #38444d; border: 2px solid #667eea; border-radius: 6px; color: #e7e9ea; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: #667eea; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Polymarket Trader Dashboard - Enhanced</h1>
            <p class="subtitle">Discover clean traders with red flag detection and advanced filtering</p>
        </header>

        <div class="upload-section">
            <h2 style="margin-bottom: 15px;">üìÅ Upload Trader Data</h2>
            <p style="margin-bottom: 15px; opacity: 0.8;">Upload your traders_detailed.json file (with red flag analysis)</p>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">Choose JSON File</button>
            <span id="fileName" style="margin-left: 15px; opacity: 0.7;"></span>
        </div>

        <div id="statsSection" class="hidden">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-label">Total Traders</div><div class="stat-value" id="totalTraders">0</div></div>
                <div class="stat-card"><div class="stat-label">Avg PnL</div><div class="stat-value" id="avgPnL">$0</div></div>
                <div class="stat-card"><div class="stat-label">Avg Win Rate</div><div class="stat-value" id="avgWinRate">0%</div></div>
                <div class="stat-card success"><div class="stat-label">‚úÖ Clean Traders</div><div class="stat-value" id="cleanCount">0</div></div>
                <div class="stat-card warning"><div class="stat-label">üö© Both-Sides</div><div class="stat-value" id="bothSidesCount">0</div></div>
                <div class="stat-card warning"><div class="stat-label">‚ö° High-Frequency</div><div class="stat-value" id="highFreqCount">0</div></div>
                <div class="stat-card"><div class="stat-label">Filtered Results</div><div class="stat-value" id="filteredCount">0</div></div>
            </div>

            <div class="filters-section">
                <h2 style="margin-bottom: 20px; color: #667eea;">üîç Filters</h2>
                <div class="filter-tabs">
                    <button class="filter-tab active" onclick="switchTab(event, 'basic')">Basic Stats</button>
                    <button class="filter-tab" onclick="switchTab(event, 'redflags')">Red Flags</button>
                    <button class="filter-tab" onclick="switchTab(event, 'odds')">Odds Analysis</button>
                    <button class="filter-tab" onclick="switchTab(event, 'advanced')">Advanced</button>
                </div>

                <!-- Basic Stats Panel -->
                <div id="basicPanel" class="filter-panel active">
                    <div class="info-box"><h4>üí° Basic Filtering</h4><p>Filter traders by fundamental metrics: profitability, win rate, trading activity, and bet sizing.</p></div>
                    <div class="filter-grid">
                        <div class="filter-group"><label>Min PnL ($)</label><input type="number" id="minPnl" value="200" step="100"></div>
                        <div class="filter-group"><label>Max PnL ($)</label><input type="number" id="maxPnl" value="100000" step="100"></div>
                        <div class="filter-group"><label>Min Win Rate (%)</label><input type="number" id="minWinRate" value="50" min="0" max="100"></div>
                        <div class="filter-group"><label>Max Win Rate (%)</label><input type="number" id="maxWinRate" value="100" min="0" max="100"></div>
                        <div class="filter-group"><label>Min Trades</label><input type="number" id="minTrades" value="20" step="10"></div>
                        <div class="filter-group"><label>Max Trades</label><input type="number" id="maxTrades" value="1000" step="10"></div>
                        <div class="filter-group"><label>Min Avg Bet ($)</label><input type="number" id="minAvgBet" value="0" step="50"></div>
                        <div class="filter-group"><label>Max Avg Bet ($)</label><input type="number" id="maxAvgBet" value="50000" step="50"></div>
                        <div class="filter-group"><label>Category</label><select id="categoryFilter"><option value="all">All Categories</option><option value="Sports">Sports</option><option value="Politics">Politics</option><option value="Crypto">Crypto</option><option value="Business">Business</option><option value="Entertainment">Entertainment</option><option value="Science">Science</option><option value="Other">Other</option></select></div>
                        <div class="filter-group"><label>Search Username</label><input type="text" id="searchUsername" placeholder="Type to search..."></div>
                    </div>
                </div>

                <!-- Red Flags Panel -->
                <div id="redflagsPanel" class="filter-panel">
                    <div class="info-box"><h4>üö© Red Flag Detection</h4><p>Avoid problematic traders: those who hedge (bet both sides), trade too frequently (bots), or chase extreme odds (lottery tickets).</p></div>
                    <div class="checkbox-group"><input type="checkbox" id="cleanTradersOnly" checked><label for="cleanTradersOnly">‚úÖ Show ONLY Clean Traders (passes all checks)</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="excludeBothSides" checked><label for="excludeBothSides">üö© Exclude Both-Sides Traders (hedgers/arbitrageurs)</label></div>
                    <div class="checkbox-group"><input type="checkbox" id="excludeHighFreq" checked><label for="excludeHighFreq">‚ö° Exclude High-Frequency Traders (>20 trades/hour)</label></div>
                    <div class="filter-grid" style="margin-top: 20px;">
                        <div class="filter-group"><label>Max Trades Per Hour</label><input type="number" id="maxTradesPerHour" value="20" min="1" max="100"></div>
                        <div class="filter-group"><label>Max Both-Sides Markets</label><input type="number" id="maxBothSidesMarkets" value="0" min="0" max="50"></div>
                    </div>
                </div>

                <!-- Odds Analysis Panel -->
                <div id="oddsPanel" class="filter-panel">
                    <div class="info-box"><h4>üé≤ Odds Analysis</h4><p>Filter by betting patterns. Ideal traders bet on reasonable odds (20-80%). Avoid extreme odds chasers.</p></div>
                    <div class="filter-grid">
                        <div class="filter-group"><label>Min Reasonable Odds % (20-80% range)</label><input type="number" id="minReasonableOdds" value="70" min="0" max="100"></div>
                        <div class="filter-group"><label>Max Extreme Low Odds % (<10%)</label><input type="number" id="maxExtremeLow" value="10" min="0" max="100"></div>
                        <div class="filter-group"><label>Max Extreme High Odds % (>90%)</label><input type="number" id="maxExtremeHigh" value="10" min="0" max="100"></div>
                        <div class="filter-group"><label>Min Avg Entry Price</label><input type="number" id="minAvgEntry" value="0.1" step="0.05" min="0" max="1"></div>
                        <div class="filter-group"><label>Max Avg Entry Price</label><input type="number" id="maxAvgEntry" value="0.9" step="0.05" min="0" max="1"></div>
                    </div>
                </div>

                <!-- Advanced Panel -->
                <div id="advancedPanel" class="filter-panel">
                    <div class="info-box"><h4>‚öôÔ∏è Advanced Filters</h4><p>Fine-tune your search with trading frequency, market diversity, and badge preferences.</p></div>
                    <div class="filter-grid">
                        <div class="filter-group"><label>Min Unique Markets</label><input type="number" id="minUniqueMarkets" value="0" step="5"></div>
                        <div class="filter-group"><label>Max Unique Markets</label><input type="number" id="maxUniqueMarkets" value="1000" step="5"></div>
                        <div class="filter-group"><label>Min Trading Sessions (hours)</label><input type="number" id="minSessions" value="0" step="10"></div>
                        <div class="filter-group"><label>Avg Trades Per Session</label><input type="number" id="maxTradesPerSession" value="100" step="5"></div>
                    </div>
                    <div style="margin-top: 20px;"><label style="display: block; margin-bottom: 10px; color: #667eea;">Badge Filters (click to require)</label><div class="toggle-section" id="badgeToggles"></div></div>
                </div>

                <button class="upload-btn" style="margin-top: 20px; width: 100%;" onclick="applyFilters()">Apply Filters</button>
            </div>

            <div class="charts-section">
                <div class="chart-card"><h3>üìä PnL Distribution</h3><canvas id="pnlChart"></canvas></div>
                <div class="chart-card"><h3>üìà Win Rate vs Clean Traders</h3><canvas id="winRateChart"></canvas></div>
                <div class="chart-card"><h3>üö© Red Flag Distribution</h3><canvas id="redFlagChart"></canvas></div>
                <div class="chart-card"><h3>üé≤ Odds Preference</h3><canvas id="oddsChart"></canvas></div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h2 style="color: #667eea;">üìã Results</h2>
                    <div class="sort-controls">
                        <label>Sort by:</label>
                        <select id="sortBy" onchange="applyFilters()">
                            <option value="clean_score">Clean Score (Best)</option>
                            <option value="pnl">PnL (High to Low)</option>
                            <option value="win_rate">Win Rate (High to Low)</option>
                            <option value="reasonable_odds">Reasonable Odds %</option>
                            <option value="trades">Total Trades</option>
                            <option value="volume">Volume</option>
                        </select>
                        <button class="export-btn" onclick="exportResults()">Export CSV</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="trader-table">
                        <thead><tr><th>#</th><th>Status</th><th>Username</th><th>PnL</th><th>Win Rate</th><th>Trades</th><th>Avg Bet</th><th>Reasonable Odds %</th><th>Max Trades/Hr</th><th>Both Sides</th><th>Category</th><th>Badges</th><th>Profile</th></tr></thead>
                        <tbody id="resultsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tradersData = [];
        let filteredData = [];
        let charts = {};

        function switchTab(event, tabName) {
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.filter-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(tabName + 'Panel').classList.add('active');
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileName').textContent = file.name;
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    tradersData = Array.isArray(data) ? data : Object.values(data);
                    document.getElementById('statsSection').classList.remove('hidden');
                    initializeBadgeToggles();
                    applyFilters();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function initializeBadgeToggles() {
            const badges = new Set();
            tradersData.forEach(trader => {
                const traderBadges = trader.badges || [];
                if (Array.isArray(traderBadges)) {
                    traderBadges.forEach(b => badges.add(b));
                } else if (typeof traderBadges === 'string') {
                    traderBadges.split(',').forEach(b => badges.add(b.trim()));
                }
            });
            const container = document.getElementById('badgeToggles');
            container.innerHTML = '';
            badges.forEach(badge => {
                const btn = document.createElement('button');
                btn.className = 'toggle-btn';
                btn.textContent = badge;
                btn.dataset.badge = badge;
                btn.onclick = function() { this.classList.toggle('active'); };
                container.appendChild(btn);
            });
        }

        function applyFilters() {
            const minPnl = parseFloat(document.getElementById('minPnl').value) || -Infinity;
            const maxPnl = parseFloat(document.getElementById('maxPnl').value) || Infinity;
            const minWinRate = parseFloat(document.getElementById('minWinRate').value) / 100 || 0;
            const maxWinRate = parseFloat(document.getElementById('maxWinRate').value) / 100 || 1;
            const minTrades = parseInt(document.getElementById('minTrades').value) || 0;
            const maxTrades = parseInt(document.getElementById('maxTrades').value) || Infinity;
            const minAvgBet = parseFloat(document.getElementById('minAvgBet').value) || 0;
            const maxAvgBet = parseFloat(document.getElementById('maxAvgBet').value) || Infinity;
            const category = document.getElementById('categoryFilter').value;
            const searchTerm = document.getElementById('searchUsername').value.toLowerCase();
            const cleanTradersOnly = document.getElementById('cleanTradersOnly').checked;
            const excludeBothSides = document.getElementById('excludeBothSides').checked;
            const excludeHighFreq = document.getElementById('excludeHighFreq').checked;
            const maxTradesPerHour = parseFloat(document.getElementById('maxTradesPerHour').value) || Infinity;
            const maxBothSidesMarkets = parseInt(document.getElementById('maxBothSidesMarkets').value) || 0;
            const minReasonableOdds = parseFloat(document.getElementById('minReasonableOdds').value) / 100 || 0;
            const maxExtremeLow = parseFloat(document.getElementById('maxExtremeLow').value) / 100 || 1;
            const maxExtremeHigh = parseFloat(document.getElementById('maxExtremeHigh').value) / 100 || 1;
            const minAvgEntry = parseFloat(document.getElementById('minAvgEntry').value) || 0;
            const maxAvgEntry = parseFloat(document.getElementById('maxAvgEntry').value) || 1;
            const minUniqueMarkets = parseInt(document.getElementById('minUniqueMarkets').value) || 0;
            const maxUniqueMarkets = parseInt(document.getElementById('maxUniqueMarkets').value) || Infinity;
            const minSessions = parseInt(document.getElementById('minSessions').value) || 0;
            const maxTradesPerSession = parseFloat(document.getElementById('maxTradesPerSession').value) || Infinity;
            const activeBadges = Array.from(document.querySelectorAll('.toggle-btn.active')).map(btn => btn.dataset.badge);

            filteredData = tradersData.filter(trader => {
                const pnl = trader.pnl || 0;
                const winRate = trader.win_rate || 0;
                const trades = trader.trades || 0;
                const avgBet = trader.avg_bet || 0;
                const traderCategory = trader.main_category || 'Other';
                const username = (trader.username || '').toLowerCase();
                const isClean = trader.is_clean_trader || false;
                const tradesBothSides = trader.trades_both_sides || false;
                const isHighFreq = trader.is_high_frequency || false;
                const maxTPH = trader.max_trades_per_hour || 0;
                const bothSidesCount = trader.both_sides_market_count || 0;
                const reasonableOdds = trader.reasonable_odds_pct || 0;
                const extremeLow = trader.extreme_low_pct || 0;
                const extremeHigh = trader.extreme_high_pct || 0;
                const avgEntry = trader.avg_entry_price || 0.5;
                const uniqueMarkets = trader.unique_markets || 0;
                const sessions = trader.trading_sessions || 0;
                const tradesPerSession = trader.trades_per_session || 0;

                let badgeMatch = activeBadges.length === 0;
                if (activeBadges.length > 0) {
                    const traderBadges = trader.badges || [];
                    const badgeArray = Array.isArray(traderBadges) ? traderBadges : (typeof traderBadges === 'string' ? traderBadges.split(',').map(b => b.trim()) : []);
                    badgeMatch = activeBadges.some(badge => badgeArray.includes(badge));
                }

                return pnl >= minPnl && pnl <= maxPnl &&
                       winRate >= minWinRate && winRate <= maxWinRate &&
                       trades >= minTrades && trades <= maxTrades &&
                       avgBet >= minAvgBet && avgBet <= maxAvgBet &&
                       (category === 'all' || traderCategory === category) &&
                       (searchTerm === '' || username.includes(searchTerm)) &&
                       badgeMatch &&
                       (!cleanTradersOnly || isClean) &&
                       (!excludeBothSides || !tradesBothSides) &&
                       (!excludeHighFreq || !isHighFreq) &&
                       maxTPH <= maxTradesPerHour &&
                       bothSidesCount <= maxBothSidesMarkets &&
                       reasonableOdds >= minReasonableOdds &&
                       extremeLow <= maxExtremeLow &&
                       extremeHigh <= maxExtremeHigh &&
                       avgEntry >= minAvgEntry &&
                       avgEntry <= maxAvgEntry &&
                       uniqueMarkets >= minUniqueMarkets &&
                       uniqueMarkets <= maxUniqueMarkets &&
                       sessions >= minSessions &&
                       tradesPerSession <= maxTradesPerSession;
            });

            const sortBy = document.getElementById('sortBy').value;
            filteredData.sort((a, b) => {
                switch(sortBy) {
                    case 'clean_score':
                        const scoreA = (!(a.trades_both_sides || false) ? 30 : 0) + (!(a.is_high_frequency || false) ? 30 : 0) + ((a.reasonable_odds_pct || 0) * 40);
                        const scoreB = (!(b.trades_both_sides || false) ? 30 : 0) + (!(b.is_high_frequency || false) ? 30 : 0) + ((b.reasonable_odds_pct || 0) * 40);
                        return scoreB - scoreA;
                    case 'pnl': return (b.pnl || 0) - (a.pnl || 0);
                    case 'win_rate': return (b.win_rate || 0) - (a.win_rate || 0);
                    case 'reasonable_odds': return (b.reasonable_odds_pct || 0) - (a.reasonable_odds_pct || 0);
                    case 'trades': return (b.trades || 0) - (a.trades || 0);
                    case 'volume': return (b.volume || 0) - (a.volume || 0);
                    default: return 0;
                }
            });

            updateStats();
            updateCharts();
            updateTable();
        }

        function updateStats() {
            document.getElementById('totalTraders').textContent = tradersData.length;
            document.getElementById('filteredCount').textContent = filteredData.length;
            const avgPnL = tradersData.reduce((sum, t) => sum + (t.pnl || 0), 0) / tradersData.length;
            const avgWR = tradersData.reduce((sum, t) => sum + (t.win_rate || 0), 0) / tradersData.length;
            const cleanCount = tradersData.filter(t => t.is_clean_trader).length;
            const bothSidesCount = tradersData.filter(t => t.trades_both_sides).length;
            const highFreqCount = tradersData.filter(t => t.is_high_frequency).length;
            document.getElementById('avgPnL').textContent = '$' + avgPnL.toFixed(0);
            document.getElementById('avgWinRate').textContent = (avgWR * 100).toFixed(1) + '%';
            document.getElementById('cleanCount').textContent = cleanCount;
            document.getElementById('bothSidesCount').textContent = bothSidesCount;
            document.getElementById('highFreqCount').textContent = highFreqCount;
        }

        function updateCharts() {
            const pnlRanges = ['<0', '0-500', '500-1K', '1K-5K', '5K-10K', '10K+'];
            const pnlCounts = [0, 0, 0, 0, 0, 0];
            filteredData.forEach(t => {
                const pnl = t.pnl || 0;
                if (pnl < 0) pnlCounts[0]++;
                else if (pnl < 500) pnlCounts[1]++;
                else if (pnl < 1000) pnlCounts[2]++;
                else if (pnl < 5000) pnlCounts[3]++;
                else if (pnl < 10000) pnlCounts[4]++;
                else pnlCounts[5]++;
            });
            if (charts.pnl) charts.pnl.destroy();
            charts.pnl = new Chart(document.getElementById('pnlChart'), {
                type: 'bar',
                data: { labels: pnlRanges, datasets: [{ label: 'Traders', data: pnlCounts, backgroundColor: '#667eea' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } }, x: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } } } }
            });

            const cleanWR = filteredData.filter(t => t.is_clean_trader).map(t => (t.win_rate || 0) * 100);
            const dirtyWR = filteredData.filter(t => !t.is_clean_trader).map(t => (t.win_rate || 0) * 100);
            if (charts.winRate) charts.winRate.destroy();
            charts.winRate = new Chart(document.getElementById('winRateChart'), {
                type: 'bar',
                data: { labels: ['Clean Traders', 'Flagged Traders'], datasets: [{ label: 'Avg Win Rate', data: [cleanWR.length ? cleanWR.reduce((a,b) => a+b) / cleanWR.length : 0, dirtyWR.length ? dirtyWR.reduce((a,b) => a+b) / dirtyWR.length : 0], backgroundColor: ['#00ba7c', '#f91880'] }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#e7e9ea', callback: value => value + '%' }, grid: { color: '#38444d' } }, x: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } } } }
            });

            const bothSides = filteredData.filter(t => t.trades_both_sides).length;
            const highFreq = filteredData.filter(t => t.is_high_frequency).length;
            const clean = filteredData.filter(t => t.is_clean_trader).length;
            if (charts.redFlag) charts.redFlag.destroy();
            charts.redFlag = new Chart(document.getElementById('redFlagChart'), {
                type: 'doughnut',
                data: { labels: ['‚úÖ Clean', 'üö© Both-Sides', '‚ö° High-Freq'], datasets: [{ data: [clean, bothSides, highFreq], backgroundColor: ['#00ba7c', '#f91880', '#ff6b6b'] }] },
                options: { responsive: true, plugins: { legend: { labels: { color: '#e7e9ea' } } } }
            });

            const lowOdds = filteredData.filter(t => (t.extreme_low_pct || 0) > 0.2).length;
            const highOdds = filteredData.filter(t => (t.extreme_high_pct || 0) > 0.2).length;
            const reasonable = filteredData.filter(t => (t.reasonable_odds_pct || 0) > 0.7).length;
            if (charts.odds) charts.odds.destroy();
            charts.odds = new Chart(document.getElementById('oddsChart'), {
                type: 'bar',
                data: { labels: ['Longshots (>20%)', 'Favorites (>20%)', 'Reasonable (>70%)'], datasets: [{ label: 'Traders', data: [lowOdds, highOdds, reasonable], backgroundColor: ['#ff6b6b', '#ffd93d', '#00ba7c'] }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } }, x: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } } } }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';
            filteredData.slice(0, 100).forEach((trader, index) => {
                const row = tbody.insertRow();
                const pnl = trader.pnl || 0;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const isClean = trader.is_clean_trader || false;
                const tradesBothSides = trader.trades_both_sides || false;
                const isHighFreq = trader.is_high_frequency || false;
                const statusHTML = isClean ? '<span class="green-badge">‚úÖ Clean</span>' : '<span class="red-flag">üö© Flagged</span>';
                const redFlagsHTML = [];
                if (tradesBothSides) redFlagsHTML.push('<span class="red-flag">üö© Both-Sides</span>');
                if (isHighFreq) redFlagsHTML.push('<span class="red-flag">‚ö° High-Freq</span>');
                const badges = trader.badges || [];
                const badgeArray = Array.isArray(badges) ? badges : (typeof badges === 'string' ? badges.split(',').map(b => b.trim()) : []);
                const badgeHTML = badgeArray.map(b => `<span class="badge">${b}</span>`).join('');
                const profileUrl = trader.profile_url || `https://polymarket.com/profile/${trader.address}`;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${statusHTML}</td>
                    <td>${trader.username || 'Anonymous'}</td>
                    <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                    <td>${((trader.win_rate || 0) * 100).toFixed(1)}%</td>
                    <td>${trader.trades || 0}</td>
                    <td>$${(trader.avg_bet || 0).toFixed(2)}</td>
                    <td>${((trader.reasonable_odds_pct || 0) * 100).toFixed(1)}%</td>
                    <td>${trader.max_trades_per_hour || 0}</td>
                    <td>${trader.both_sides_market_count || 0}</td>
                    <td>${trader.main_category || 'Other'}</td>
                    <td>${badgeHTML}${redFlagsHTML.join('')}</td>
                    <td><a href="${profileUrl}" target="_blank" class="profile-link">View</a></td>
                `;
            });
            if (filteredData.length > 100) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="13" style="text-align: center; padding: 20px; opacity: 0.7;">Showing top 100 results of ${filteredData.length} total</td>`;
            }
            if (filteredData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="13" style="text-align: center; padding: 40px;"><div style="font-size: 18px; opacity: 0.7;">No traders match your filters</div><div style="margin-top: 10px; opacity: 0.5;">Try relaxing some filter criteria</div></td>`;
            }
        }

        function exportResults() {
            if (filteredData.length === 0) { alert('No data to export'); return; }
            const csv = [
                ['Username', 'PnL', 'Win Rate', 'Trades', 'Avg Bet', 'Volume', 'Category', 'Is Clean', 'Both Sides', 'High Frequency', 'Reasonable Odds %', 'Max Trades/Hr', 'Badges', 'Profile URL'],
                ...filteredData.map(t => [
                    t.username || 'Anonymous', t.pnl || 0, t.win_rate || 0, t.trades || 0, t.avg_bet || 0, t.volume || 0, t.main_category || 'Other',
                    t.is_clean_trader ? 'Yes' : 'No', t.trades_both_sides ? 'Yes' : 'No', t.is_high_frequency ? 'Yes' : 'No',
                    ((t.reasonable_odds_pct || 0) * 100).toFixed(1), t.max_trades_per_hour || 0,
                    Array.isArray(t.badges) ? t.badges.join(', ') : t.badges || '', t.profile_url || `https://polymarket.com/profile/${t.address}`
                ])
            ].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'filtered_traders_enhanced.csv';
            a.click();
        }
    </script>
</body>
</html>