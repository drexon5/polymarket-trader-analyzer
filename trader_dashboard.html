<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Trader Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e7e9ea;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .upload-section {
            background: #1a1f2e;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
        }
        
        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .upload-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }
        
        .filters-section {
            background: #1a1f2e;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #667eea;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 10px;
            background: #0f1419;
            border: 1px solid #38444d;
            border-radius: 6px;
            color: #e7e9ea;
            font-size: 14px;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .toggle-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .toggle-btn {
            padding: 8px 16px;
            background: #38444d;
            border: 2px solid #667eea;
            border-radius: 6px;
            color: #e7e9ea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #667eea;
            color: white;
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 12px;
        }
        
        .chart-card h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .results-section {
            background: #1a1f2e;
            padding: 25px;
            border-radius: 12px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-controls select {
            padding: 8px 12px;
            background: #0f1419;
            border: 1px solid #667eea;
            border-radius: 6px;
            color: #e7e9ea;
        }
        
        .trader-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }
        
        .trader-table th {
            background: #667eea;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .trader-table td {
            padding: 12px;
            border-bottom: 1px solid #38444d;
        }
        
        .trader-table tr:hover {
            background: #252d3d;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 4px;
            background: #667eea;
            color: white;
        }
        
        .profile-link {
            color: #667eea;
            text-decoration: none;
        }
        
        .profile-link:hover {
            text-decoration: underline;
        }
        
        .positive {
            color: #00ba7c;
        }
        
        .negative {
            color: #f91880;
        }
        
        .hidden {
            display: none;
        }
        
        .export-btn {
            background: #00ba7c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .export-btn:hover {
            background: #00a36c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Polymarket Trader Dashboard</h1>
            <p class="subtitle">Discover and analyze underrated traders with advanced filtering</p>
        </header>

        <div class="upload-section">
            <h2 style="margin-bottom: 15px;">üìÅ Upload Trader Data</h2>
            <p style="margin-bottom: 15px; opacity: 0.8;">Upload your traders_quick.json or traders_detailed.json file</p>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                Choose JSON File
            </button>
            <span id="fileName" style="margin-left: 15px; opacity: 0.7;"></span>
        </div>

        <div id="statsSection" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Traders</div>
                    <div class="stat-value" id="totalTraders">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg PnL</div>
                    <div class="stat-value" id="avgPnL">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Win Rate</div>
                    <div class="stat-value" id="avgWinRate">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Filtered Results</div>
                    <div class="stat-value" id="filteredCount">0</div>
                </div>
            </div>

            <div class="filters-section">
                <h2 style="margin-bottom: 20px; color: #667eea;">üîç Filters</h2>
                
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Min PnL ($)</label>
                        <input type="number" id="minPnl" value="200" step="100">
                    </div>
                    <div class="filter-group">
                        <label>Max PnL ($)</label>
                        <input type="number" id="maxPnl" value="100000" step="100">
                    </div>
                    <div class="filter-group">
                        <label>Min Win Rate (%)</label>
                        <input type="number" id="minWinRate" value="50" min="0" max="100">
                    </div>
                    <div class="filter-group">
                        <label>Max Win Rate (%)</label>
                        <input type="number" id="maxWinRate" value="100" min="0" max="100">
                    </div>
                    <div class="filter-group">
                        <label>Min Trades</label>
                        <input type="number" id="minTrades" value="20" step="10">
                    </div>
                    <div class="filter-group">
                        <label>Max Trades</label>
                        <input type="number" id="maxTrades" value="1000" step="10">
                    </div>
                    <div class="filter-group">
                        <label>Min Avg Bet ($)</label>
                        <input type="number" id="minAvgBet" value="0" step="50">
                    </div>
                    <div class="filter-group">
                        <label>Max Avg Bet ($)</label>
                        <input type="number" id="maxAvgBet" value="50000" step="50">
                    </div>
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="Sports">Sports</option>
                            <option value="Politics">Politics</option>
                            <option value="Crypto">Crypto</option>
                            <option value="Business">Business</option>
                            <option value="Entertainment">Entertainment</option>
                            <option value="Science">Science</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search Username</label>
                        <input type="text" id="searchUsername" placeholder="Type to search...">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; color: #667eea;">Badge Filters (click to toggle)</label>
                    <div class="toggle-section" id="badgeToggles"></div>
                </div>

                <button class="upload-btn" style="margin-top: 20px;" onclick="applyFilters()">
                    Apply Filters
                </button>
            </div>

            <div class="charts-section" id="chartsSection">
                <div class="chart-card">
                    <h3>üìä PnL Distribution</h3>
                    <canvas id="pnlChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üìà Win Rate Distribution</h3>
                    <canvas id="winRateChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>üé≤ Trading Activity</h3>
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h2 style="color: #667eea;">üìã Results</h2>
                    <div class="sort-controls">
                        <label>Sort by:</label>
                        <select id="sortBy" onchange="applyFilters()">
                            <option value="pnl">PnL (High to Low)</option>
                            <option value="pnl_asc">PnL (Low to High)</option>
                            <option value="win_rate">Win Rate (High to Low)</option>
                            <option value="win_rate_asc">Win Rate (Low to High)</option>
                            <option value="trades">Total Trades</option>
                            <option value="avg_bet">Avg Bet Size</option>
                            <option value="volume">Volume</option>
                        </select>
                        <button class="export-btn" onclick="exportResults()">Export CSV</button>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="trader-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Username</th>
                                <th>PnL</th>
                                <th>Win Rate</th>
                                <th>Trades</th>
                                <th>Avg Bet</th>
                                <th>Volume</th>
                                <th>Category</th>
                                <th>Badges</th>
                                <th>Profile</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tradersData = [];
        let filteredData = [];
        let charts = {};

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    // Convert object to array if needed
                    if (Array.isArray(data)) {
                        tradersData = data;
                    } else {
                        tradersData = Object.values(data);
                    }

                    document.getElementById('statsSection').classList.remove('hidden');
                    initializeBadgeToggles();
                    applyFilters();
                } catch (error) {
                    alert('Error parsing JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        function initializeBadgeToggles() {
            const badges = new Set();
            tradersData.forEach(trader => {
                const traderBadges = trader.badges || [];
                if (Array.isArray(traderBadges)) {
                    traderBadges.forEach(b => badges.add(b));
                } else if (typeof traderBadges === 'string') {
                    traderBadges.split(',').forEach(b => badges.add(b.trim()));
                }
            });

            const container = document.getElementById('badgeToggles');
            container.innerHTML = '';
            
            badges.forEach(badge => {
                const btn = document.createElement('button');
                btn.className = 'toggle-btn';
                btn.textContent = badge;
                btn.dataset.badge = badge;
                btn.onclick = function() {
                    this.classList.toggle('active');
                };
                container.appendChild(btn);
            });
        }

        function applyFilters() {
            const minPnl = parseFloat(document.getElementById('minPnl').value) || -Infinity;
            const maxPnl = parseFloat(document.getElementById('maxPnl').value) || Infinity;
            const minWinRate = parseFloat(document.getElementById('minWinRate').value) / 100 || 0;
            const maxWinRate = parseFloat(document.getElementById('maxWinRate').value) / 100 || 1;
            const minTrades = parseInt(document.getElementById('minTrades').value) || 0;
            const maxTrades = parseInt(document.getElementById('maxTrades').value) || Infinity;
            const minAvgBet = parseFloat(document.getElementById('minAvgBet').value) || 0;
            const maxAvgBet = parseFloat(document.getElementById('maxAvgBet').value) || Infinity;
            const category = document.getElementById('categoryFilter').value;
            const searchTerm = document.getElementById('searchUsername').value.toLowerCase();

            // Get active badges
            const activeBadges = Array.from(document.querySelectorAll('.toggle-btn.active'))
                .map(btn => btn.dataset.badge);

            filteredData = tradersData.filter(trader => {
                const pnl = trader.pnl || 0;
                const winRate = trader.win_rate || 0;
                const trades = trader.trades || 0;
                const avgBet = trader.avg_bet || 0;
                const traderCategory = trader.main_category || 'Other';
                const username = (trader.username || '').toLowerCase();

                // Badge filter
                let badgeMatch = activeBadges.length === 0;
                if (activeBadges.length > 0) {
                    const traderBadges = trader.badges || [];
                    const badgeArray = Array.isArray(traderBadges) 
                        ? traderBadges 
                        : (typeof traderBadges === 'string' ? traderBadges.split(',').map(b => b.trim()) : []);
                    
                    badgeMatch = activeBadges.some(badge => badgeArray.includes(badge));
                }

                return pnl >= minPnl && pnl <= maxPnl &&
                       winRate >= minWinRate && winRate <= maxWinRate &&
                       trades >= minTrades && trades <= maxTrades &&
                       avgBet >= minAvgBet && avgBet <= maxAvgBet &&
                       (category === 'all' || traderCategory === category) &&
                       (searchTerm === '' || username.includes(searchTerm)) &&
                       badgeMatch;
            });

            // Sort
            const sortBy = document.getElementById('sortBy').value;
            filteredData.sort((a, b) => {
                switch(sortBy) {
                    case 'pnl': return (b.pnl || 0) - (a.pnl || 0);
                    case 'pnl_asc': return (a.pnl || 0) - (b.pnl || 0);
                    case 'win_rate': return (b.win_rate || 0) - (a.win_rate || 0);
                    case 'win_rate_asc': return (a.win_rate || 0) - (b.win_rate || 0);
                    case 'trades': return (b.trades || 0) - (a.trades || 0);
                    case 'avg_bet': return (b.avg_bet || 0) - (a.avg_bet || 0);
                    case 'volume': return (b.volume || 0) - (a.volume || 0);
                    default: return 0;
                }
            });

            updateStats();
            updateCharts();
            updateTable();
        }

        function updateStats() {
            document.getElementById('totalTraders').textContent = tradersData.length;
            document.getElementById('filteredCount').textContent = filteredData.length;

            const avgPnL = tradersData.reduce((sum, t) => sum + (t.pnl || 0), 0) / tradersData.length;
            const avgWR = tradersData.reduce((sum, t) => sum + (t.win_rate || 0), 0) / tradersData.length;

            document.getElementById('avgPnL').textContent = '$' + avgPnL.toFixed(0);
            document.getElementById('avgWinRate').textContent = (avgWR * 100).toFixed(1) + '%';
        }

        function updateCharts() {
            // PnL Distribution
            const pnlRanges = ['<0', '0-500', '500-1K', '1K-5K', '5K-10K', '10K+'];
            const pnlCounts = [0, 0, 0, 0, 0, 0];
            
            filteredData.forEach(t => {
                const pnl = t.pnl || 0;
                if (pnl < 0) pnlCounts[0]++;
                else if (pnl < 500) pnlCounts[1]++;
                else if (pnl < 1000) pnlCounts[2]++;
                else if (pnl < 5000) pnlCounts[3]++;
                else if (pnl < 10000) pnlCounts[4]++;
                else pnlCounts[5]++;
            });

            if (charts.pnl) charts.pnl.destroy();
            charts.pnl = new Chart(document.getElementById('pnlChart'), {
                type: 'bar',
                data: {
                    labels: pnlRanges,
                    datasets: [{
                        label: 'Traders',
                        data: pnlCounts,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } },
                        x: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } }
                    }
                }
            });

            // Win Rate Distribution
            const wrRanges = ['<40%', '40-50%', '50-60%', '60-70%', '70-80%', '80%+'];
            const wrCounts = [0, 0, 0, 0, 0, 0];
            
            filteredData.forEach(t => {
                const wr = (t.win_rate || 0) * 100;
                if (wr < 40) wrCounts[0]++;
                else if (wr < 50) wrCounts[1]++;
                else if (wr < 60) wrCounts[2]++;
                else if (wr < 70) wrCounts[3]++;
                else if (wr < 80) wrCounts[4]++;
                else wrCounts[5]++;
            });

            if (charts.winRate) charts.winRate.destroy();
            charts.winRate = new Chart(document.getElementById('winRateChart'), {
                type: 'bar',
                data: {
                    labels: wrRanges,
                    datasets: [{
                        label: 'Traders',
                        data: wrCounts,
                        backgroundColor: '#00ba7c'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } },
                        x: { ticks: { color: '#e7e9ea' }, grid: { color: '#38444d' } }
                    }
                }
            });

            // Activity Chart
            const activityRanges = ['<50', '50-100', '100-200', '200-500', '500+'];
            const activityCounts = [0, 0, 0, 0, 0];
            
            filteredData.forEach(t => {
                const trades = t.trades || 0;
                if (trades < 50) activityCounts[0]++;
                else if (trades < 100) activityCounts[1]++;
                else if (trades < 200) activityCounts[2]++;
                else if (trades < 500) activityCounts[3]++;
                else activityCounts[4]++;
            });

            if (charts.activity) charts.activity.destroy();
            charts.activity = new Chart(document.getElementById('activityChart'), {
                type: 'doughnut',
                data: {
                    labels: activityRanges,
                    datasets: [{
                        data: activityCounts,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#e7e9ea' } }
                    }
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';

            filteredData.slice(0, 100).forEach((trader, index) => {
                const row = tbody.insertRow();
                
                const pnl = trader.pnl || 0;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                
                const badges = trader.badges || [];
                const badgeArray = Array.isArray(badges) ? badges : (typeof badges === 'string' ? badges.split(',').map(b => b.trim()) : []);
                const badgeHTML = badgeArray.map(b => `<span class="badge">${b}</span>`).join('');

                const profileUrl = trader.profile_url || `https://polymarket.com/profile/${trader.address}`;

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${trader.username || 'Anonymous'}</td>
                    <td class="${pnlClass}">$${pnl.toFixed(2)}</td>
                    <td>${((trader.win_rate || 0) * 100).toFixed(1)}%</td>
                    <td>${trader.trades || 0}</td>
                    <td>$${(trader.avg_bet || 0).toFixed(2)}</td>
                    <td>$${(trader.volume || 0).toFixed(0)}</td>
                    <td>${trader.main_category || 'Other'}</td>
                    <td>${badgeHTML}</td>
                    <td><a href="${profileUrl}" target="_blank" class="profile-link">View</a></td>
                `;
            });

            if (filteredData.length > 100) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="10" style="text-align: center; padding: 20px; opacity: 0.7;">Showing top 100 results of ${filteredData.length} total</td>`;
            }
        }

        function exportResults() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }

            const csv = [
                ['Username', 'PnL', 'Win Rate', 'Trades', 'Avg Bet', 'Volume', 'Category', 'Badges', 'Profile URL'],
                ...filteredData.map(t => [
                    t.username || 'Anonymous',
                    t.pnl || 0,
                    t.win_rate || 0,
                    t.trades || 0,
                    t.avg_bet || 0,
                    t.volume || 0,
                    t.main_category || 'Other',
                    Array.isArray(t.badges) ? t.badges.join(', ') : t.badges || '',
                    t.profile_url || `https://polymarket.com/profile/${t.address}`
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'filtered_traders.csv';
            a.click();
        }
    </script>
</body>
</html>